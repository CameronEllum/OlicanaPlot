<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Column Selection</title>
    <link rel="stylesheet" href="dialog-theme.css">
    <style>
        /* CSV-specific styles */
        .file-section {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .file-header {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-header::before {
            content: '';
            display: block;
            width: 3px;
            height: 12px;
            background: var(--slider-progress);
            border-radius: 2px;
        }

        .file-path-input {
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            font-size: 12px;
        }

        .columns-section {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            backdrop-filter: blur(10px);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .columns-header {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .columns-header::before {
            content: '';
            display: block;
            width: 3px;
            height: 12px;
            background: var(--slider-progress);
            border-radius: 2px;
        }

        .columns-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            flex: 1;
            min-height: 0;
        }

        .y-columns-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .y-columns-container select[multiple] {
            flex: 1;
            min-height: 100px;
        }

        .btn-load {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 14px var(--accent-glow);
        }

        .btn-load:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35);
        }

        .btn-load:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <!-- Custom Title Bar -->
    <div class="title-bar">
        <span class="title-bar-text">CSV Column Selection</span>
        <div class="title-bar-controls">
            <button class="title-btn close" id="close-btn" title="Close">✕</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content">
        <form id="csv-form">
            <!-- File Section -->
            <div class="file-section">
                <div class="file-header">Selected File</div>
                <input type="text" id="file-path" class="file-path-input" readonly disabled>
            </div>

            <!-- Columns Section -->
            <div class="columns-section">
                <div class="columns-header">Column Mapping</div>
                <div class="columns-content">
                    <div class="form-group">
                        <label for="x-column">X Column (Domain)</label>
                        <select id="x-column" required>
                            <option value="Index">Index (0 to N)</option>
                            <option disabled>──────────</option>
                        </select>
                    </div>

                    <div class="y-columns-container">
                        <label for="y-columns">Y Columns (Series)</label>
                        <select id="y-columns" multiple size="6" required>
                        </select>
                        <small>Hold Ctrl/Cmd to select multiple columns</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="buttons">
                <button type="button" class="btn-cancel" id="cancel-btn">Cancel</button>
                <button type="submit" class="btn-load">Load Data</button>
            </div>
        </form>
    </div>

    <script type="module">
        import { Events } from '@wailsio/runtime';

        if (!Events) {
            alert('Wails Runtime "Events" not found!');
        }

        const params = new URLSearchParams(window.location.search);
        const selectedFile = params.get('file') || '';
        const headersJSON = params.get('headers') || '[]';
        let headers = [];

        try {
            headers = JSON.parse(headersJSON);
        } catch (e) {
            console.error('Failed to parse headers:', e);
            alert('Failed to parse headers: ' + e);
        }

        if (selectedFile) {
            document.getElementById('file-path').value = selectedFile;
        }

        function populateColumnSelects(columns) {
            const xSelect = document.getElementById('x-column');
            const ySelect = document.getElementById('y-columns');

            xSelect.innerHTML = '<option value="Index">Index (0 to N)</option><option disabled>──────────</option>';
            ySelect.innerHTML = '';

            columns.forEach(col => {
                const xOption = document.createElement('option');
                xOption.value = col;
                xOption.textContent = col;
                xSelect.appendChild(xOption);

                const yOption = document.createElement('option');
                yOption.value = col;
                yOption.textContent = col;
                ySelect.appendChild(yOption);
            });
        }

        if (headers.length > 0) {
            populateColumnSelects(headers);
            if (headers.length > 0) {
                document.getElementById('x-column').value = headers[0];
            }
            if (headers.length > 1) {
                const ySelect = document.getElementById('y-columns');
                for (let i = 1; i < headers.length; i++) {
                    ySelect.options[i].selected = true;
                }
            }
        }

        document.getElementById('csv-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const xColumn = document.getElementById('x-column').value;
            const yColumnsElement = document.getElementById('y-columns');
            const yColumns = Array.from(yColumnsElement.selectedOptions).map(opt => opt.value);

            if (!xColumn) {
                alert('Please select an X column');
                return;
            }

            if (yColumns.length === 0) {
                alert('Please select at least one Y column');
                return;
            }

            try {
                await Events.Emit('csv-config-submit', {
                    file: selectedFile,
                    xColumn: xColumn,
                    yColumns: yColumns
                });
            } catch (err) {
                alert('Error submitting: ' + err);
            }
        });

        document.getElementById('cancel-btn').addEventListener('click', async () => {
            try {
                await Events.Emit('csv-config-cancel');
            } catch (err) {
                alert('Error cancelling: ' + err);
            }
        });

        document.getElementById('close-btn').addEventListener('click', async () => {
            try {
                await Events.Emit('csv-config-cancel');
            } catch (err) {
                alert('Error cancelling: ' + err);
            }
        });
    </script>
</body>

</html>